version: '3'
services:
  elasticsearch:
    container_name: es-container
    image: docker.elastic.co/elasticsearch/elasticsearch:8.1.2
    environment:
      - xpack.security.enabled=false
      - "discovery.type=single-node"
    networks:
      - es-net
    ports:
      - 9200:9200
    volumes:
    - es-data:/usr/share/elasticsearch/data
    deploy:
      resources:
        limits:
          memory: 2g
        reservations:
          memory: 1g

  kibana:
    container_name: kb-container
    image: docker.elastic.co/kibana/kibana:8.1.2
    environment:
      - ELASTICSEARCH_HOSTS=http://es-container:9200
    networks:
      - es-net
    depends_on:
      - elasticsearch
    ports:
      - 5601:5601

  chargement:
    build: ./chargement
    image: khalilouertani99/job_market_chargement:latest
    depends_on:
      - elasticsearch
    container_name: chargement
    networks:
      - es-net
    volumes:
      - shared-data:/data
    command: ["/usr/bin/wait-for-it.sh", "es-container:9200", "--", "python", "executor.py"]

  ml-processing:
    build: ./ML
    image: khalilouertani99/job_market_ml-processing:latest
    depends_on:
      - elasticsearch
      - chargement
    container_name: ml-processing
    networks:
      - es-net
    volumes:
      - shared-data:/data
    command: ["bash", "-c", "while [ ! -f /data/chargement_done.txt ]; do echo 'Waiting for chargement to complete...'; sleep 15; done; /app/run_all.sh"]
  
  api:
    build: ./api
    image: khalilouertani99/job_market_api:latest
    depends_on:
      - elasticsearch
      - ml-processing
    container_name: api-container
    networks:
      - es-net
    volumes:
      - shared-data:/data
    ports:
      - 8000:8000
    command: ["bash", "-c", "while [ ! -f /data/tfidf_vectorizer.pkl ] || [ ! -f /data/word2vec_model.model ]; do echo 'Waiting for models to be available...'; sleep 15; done; uvicorn main:app --host 0.0.0.0 --port 8000"]

networks:
  es-net:
    driver: bridge

volumes:
  es-data:
    driver: local
  shared-data:
    driver: local